{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %} {% trans "Available Transport" %} {% endblock %}

{% block content %}
<h2>{% trans "Available Transport" %}</h2>
<form method="get" class="filter-form">
    <div class="filter-item">
        <label for="type">{% trans "Type:" %}</label>
        <select name="type">
            <option value="">{% trans "All" %}</option>
            <option value="E-Bike">{% trans "E-Bike" %}</option>
            <option value="E-Scooter">{% trans "E-Scooter" %}</option>
            <option value="Bike">{% trans "Bike" %}</option>
        </select>
    </div>

    <div class="filter-item">
        <label for="min_battery">{% trans "Minimum Battery:" %}</label>
        <input type="number" name="min_battery" min="0" max="100">
    </div>

    <button type="submit" class="filter-button">{% trans "Filter" %}</button>
</form>

<div id="map"></div>
<h1>{% trans "Stations:" %} {{ stations|length }} </h1>
{{ stations|json_script:"EV_stations_json" }}
<script>
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
        console.log("{% trans 'Geolocation is not supported by this browser.' %}");
    }
    let map;

    function initializeMap(){
        map = L.map('map').setView([53.33833948672929, -6.2990109445410996], 13);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
    }
    
    function showPosition(position) {
        let userLat = position.coords.latitude;
        let userLon = position.coords.longitude;
        if(map){
            map.setView([userLat, userLon], 15)
            setTimeout(() => {
                L.marker([userLat, userLon]).bindPopup("{% trans 'You are here' %}").openPopup().addTo(map);
            }, 500);
        } else {
            console.error("{% trans 'Map is not initialized yet' %}");
        }
    } 

    function showError(error) {
        console.log("{% trans 'Error getting location:' %}", error.message);
    }

    initializeMap();
    let stations = JSON.parse(document.getElementById('EV_stations_json').textContent);
    console.log(stations);
    stations.forEach(station => {
        L.marker([station.latitude, station.longitude]).bindPopup(`<b>{% trans 'Max spaces:' %} ${station.max_spaces}</b>
        <br>{% trans 'Free spaces:' %} ${station.free_spaces}<br>${station.address}`).openPopup().addTo(map);
    });
</script>

<div class="vehicle-list">
    {% for vehicle in vehicles %}
    <div class="vehicle-card">
        <div class="vehicle-image">
            {% if vehicle.type == "E-Bike" %}
                <img src="{% static 'images/e-bike.jpg' %}" alt="{% trans 'E-Bike image' %}" />
            {% elif vehicle.type == "E-Scooter" %}
                <img src="{% static 'images/e-scooter.jpg' %}" alt="{% trans 'E-Scooter image' %}" />
            {% elif vehicle.type == "Bike" %}
                <img src="{% static 'images/bike.webp' %}" alt="{% trans 'Bike image' %}" />
            {% else %}
                <img src="{% static 'placeholder.jpg' %}" alt="{% trans 'Default image' %}" />
            {% endif %}
        </div>
        <div class="vehicle-details">
            <h3>{{ vehicle.type }}</h3>
            {% if vehicle.battery_percentage is not None %}
                <p>{% trans "Battery:" %} {{ vehicle.battery_percentage }}%</p>
            {% endif %}
            <p>{% trans "Status:" %} {% if vehicle.status %}{% trans "Available" %}{% else %}{% trans "Not Available" %}{% endif %}</p>
            <a href="https://www.google.com/maps?q={{ vehicle.latitude }},{{ vehicle.longitude }}" target="_blank">{% trans "Show on Map" %}</a>
        </div>
        <div class="vehicle-price">
            <p>{% trans "Price per hour:" %} â‚¬{{ vehicle.price_per_hour }}</p>
            <form method="get" action="{% url 'stripe_payment' vehicle.id %}">
                <input type="number" name="hours" min="1" value="1" class="hours-input">
                <button type="submit" class="rent-button">Pay with Stripe</button>
            </form>
            <form method="get" action="{% url 'paypal_payment' vehicle.id %}">
                <input type="number" name="hours" min="1" value="1" class="hours-input">
                <button type="submit" class="rent-button">Pay with PayPal</button>
            </form>
        </div>
    </div>
    {% empty %}
    <p>{% trans "No vehicles found" %}</p>
    {% endfor %}
</div>
{% endblock %}